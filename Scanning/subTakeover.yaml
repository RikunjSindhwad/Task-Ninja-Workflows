config:
  name: "Subdomain Takever Check"
  author: "Rikunj Sindhwad"
  usage: "Task-Ninja -w subTakeover.yaml -v LIST=subdomains.txt,RESULT=results.csv"
  # stdoutDir: log
  # stderrDir: log
vars:
  LIST: ""
  HIVE: "hive"
  INPUT_DIR: "hive/in"
  OUTPUT_DIR: "hive/out"
  centdocker: "quay.io/trickest/cent:1ebc728-patch-3" # Credit Trickest
  nucleidocker: "projectdiscovery/nuclei@latest"
  dockerinput: "/hive/in"
  dockeroutput: "/hive/out"
  RESULT: "" # Modify final list name


tasks:
 - name: Validate Requirements
    silent: false
    parallel: false
    stoponerr: true
    cmds:
      - programs=("docker" "wget" "jq")
      - for program in "${programs[@]}"; do command -v "$program" >/dev/null 2>&1 || { echo >&2 "$program is not installed."; exit 1;}; done
  - name: mkdir
    silent: true
    parallel: false
    cmds:
      - rm -rf {{OUTPUT_DIR}} {{INPUT_DIR}}
      - mkdir -p {{OUTPUT_DIR}} {{INPUT_DIR}}
  - name: download-cent-templates and filter for takeover
    silent: true
    parallel: false
    cmds:
      - wget -q https://raw.githubusercontent.com/RikunjSindhwad/Task-Ninja-Workflows/main/Inventory/.cent.yaml -O {{INPUT_DIR}}/cent.yml # Credit Trickest
      - docker container run --rm -v "$(pwd)/{{HIVE}}:/hive" {{centdocker}} {{dockerinput}}/cent.yml {{dockeroutput}}/cent-templates 2>/dev/null
      - mkdir -p {{INPUT_DIR}}/cent-templates-takeover
      - mv {{OUTPUT_DIR}}/cent-templates/*-takeover* {{INPUT_DIR}}/cent-templates-takeover
      - rm -rf {{OUTPUT_DIR}}/cent-templates
  - name: Run Nuclei
    silent: true
    parallel: false
    cmds:
      - cp {{LIST}} {{INPUT_DIR}}/subdomains.txt
      - docker container run --rm -v "$(pwd)/{{HIVE}}:/hive" {{nucleidocker}} -j -nc -silent -templates {{dockerinput}}/cent-templates-takeover -list {{dockerinput}}/subdomains.txt -concurrency 300 -output {{dockeroutput}}/nuclei-takeover.json
  - name: CSV-Result
    silent: false
    parallel: false
    required: 
      - Run Nuclei
    cmds:
      - jq -r '["\(.["template-id"] // ""):\(.["matcher-name"] // "")",."type" // "",.info.severity // "",."matched-at" // "",if ."extracted-results" | type == "array" then (.["extracted-results"] | join(", ")) else ."extracted-results" // "" end,.ip // ""] | @csv' {{OUTPUT_DIR}}/nuclei-takeover.json > {{RESULT}}
