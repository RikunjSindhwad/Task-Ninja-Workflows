config:
  name: "ZAP Scanner"
  author: "Rikunj Sindhwad"
  usage: "./TaskNinja -w zap_scanner.yaml -w url_list"
  # stdoutDir: log
  # stderrDir: log
vars:
  HIVE: "$(pwd)/hive"
  INPUT_DIR: "hive/in"
  OUTPUT_DIR: "hive/out"
  DOCKER_IN: "/hive/in"
  DOCKER_OUT: "/hive/out"
  helperdocker: "robensive/zap-context_helper:latest"
  zapdocker: "ghcr.io/zaproxy/zaproxy:stable"
  zapworkdir: "/zap/wrk"
  zap_yaml: "https://raw.githubusercontent.com/RikunjSindhwad/Task-Ninja-Workflows/main/Inventory/ZAP_Framework.yaml" # Input context yaml file here // Note: Modify MAX time if using default
  url_list: "" # Input List of URLS to scan
tasks:
  - name: Create Required Directories
    silent: true
    parallel: false
    cmds:
      - rm -rf {{OUTPUT_DIR}} {{INPUT_DIR}}
      - mkdir -p {{OUTPUT_DIR}} {{INPUT_DIR}}
  - name: Downnload zap yaml
    silent: true
    parallel: false
    cmds:
      - wget '{{zap_yaml}}' -O {{INPUT_DIR}}/zap_scan.yaml
  - name: Modify ZAP config
    silent: true
    parallel: false
    cmds:
      - cp {{url_list}} {{INPUT_DIR}}/urls.txt
      - sudo docker container run --rm -v $(pwd)/hive:/hive {{helperdocker}} -u {{DOCKER_IN}}/urls.txt -i {{DOCKER_IN}}/zap_scan.yaml -o {{DOCKER_OUT}}/zap_scan.yaml
  - name: run ZAP
    silent: true
    parallel: false
    cmds:
      - mkdir -p {{OUTPUT_DIR}}/zap
      - sudo docker container run --user 0 --rm -v $(pwd)/hive:{{zapworkdir}} {{zapdocker}} zap.sh -cmd -autorun {{zapworkdir}}/out/zap_scan.yaml
  - name: Result-Check
    silent: false
    parallel: false
    cmds:
      - result=$(find {{OUTPUT_DIR}}/zap -type f -name '*.json')
      - jq -r '.site[].alerts[] | select(.instances) as $alert | .instances[] | [$alert.name, $alert.riskdesc, .uri, .param, .method, .evidence] | @csv' $result | tee {{OUTPUT_DIR}}/ZAP-Result.CSV
      - echo result saved in {{OUTPUT_DIR}}/ZAP-Result.CSV
